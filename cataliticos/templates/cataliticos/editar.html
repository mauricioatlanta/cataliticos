{% extends 'base.html' %}
{% load formato_moneda %}

{% block title %}Editar Catal√≠tico - Atlanta Reciclajes{% endblock %}

{% block content %}
<style>
/* Glassmorphism total para toda la p√°gina de edici√≥n */
.bg-glass {
    background: rgba(0,0,0,0.10) !important;
    backdrop-filter: blur(12px) !important;
    border-radius: 1.25rem !important;
    border: 1px solid rgba(255,255,255,0.10) !important;
    box-shadow: 0 8px 32px 0 rgba(31,38,135,0.20) !important;
}
.card-glass {
    background: rgba(255,255,255,0.08) !important;
    backdrop-filter: blur(8px) !important;
    border-radius: 1rem !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    box-shadow: 0 4px 16px 0 rgba(31,38,135,0.10) !important;
}
input, select, textarea {
    background: rgba(255,255,255,0.10) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,0.25) !important;
    border-radius: 0.75rem !important;
    padding: 0.75rem !important;
    font-size: 1rem !important;
    backdrop-filter: blur(4px) !important;
}
input::placeholder, select::placeholder, textarea::placeholder {
    color: rgba(255,255,255,0.7) !important;
}
label {
    color: #fff !important;
    font-weight: 600 !important;
}
.btn-primary, .btn-secondary, .btn-danger {
    background: rgba(0,0,0,0.15) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,0.18) !important;
    border-radius: 0.75rem !important;
    font-weight: bold !important;
    transition: all 0.2s;
}
.btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
    background: rgba(0,0,0,0.25) !important;
    color: #fff !important;
}
.mensaje-validacion, .mensaje-exito, .mensaje-error {
    background: rgba(0,0,0,0.10) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,0.18) !important;
    border-radius: 0.5rem !important;
    backdrop-filter: blur(4px) !important;
}
</style>

<div class="max-w-4xl mx-auto p-6 bg-glass">
    <h1 class="text-3xl font-bold mb-6 text-white text-center">‚úèÔ∏è Editar Catal√≠tico</h1>
    
    <div class="mb-6 p-4 card-glass">
        <div class="flex flex-wrap justify-between items-center">
            <div>
                <p class="text-sm text-blue-200"><strong>C√≥digo actual:</strong> {{ catalitico.codigo }}</p>
                <p class="text-sm text-blue-200"><strong>Valor actual:</strong> {{ catalitico.valor|formato_pesos }}</p>
            </div>
            <div class="text-sm text-blue-200">
                ID: #{{ catalitico.id }}
            </div>
        </div>
    </div>
    <!-- Mensajes de Django -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-4 rounded-lg mb-3 card-glass">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="card-glass p-4 mb-4">
                <h3 class="font-bold mb-2">‚ö†Ô∏è Errores en el formulario:</h3>
                {% for error in form.non_field_errors %}
                    <p class="text-red-300 text-sm">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        <div class="card-glass p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4 text-white">üìã Informaci√≥n B√°sica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.codigo.id_for_label }}">
                        {{ form.codigo.label }} <span class="campo-requerido">*</span>
                    </label>
                    {{ form.codigo }}
                    <div id="codigo-validacion" class="mensaje-validacion" style="display: none;"></div>
                    {% if form.codigo.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.codigo.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <p class="text-xs text-gray-300 mt-1">El c√≥digo debe ser √∫nico y se convertir√° autom√°ticamente a may√∫sculas</p>
                </div>
                <div>
                    <label for="{{ form.descripcion.id_for_label }}">
                        {{ form.descripcion.label }} <span class="campo-requerido">*</span>
                    </label>
                    {{ form.descripcion }}
                    {% if form.descripcion.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.descripcion.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="md:col-span-2">
                    <label for="{{ form.valor.id_for_label }}">
                        {{ form.valor.label }} <span class="campo-requerido">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                        <input type="number" name="valor" id="{{ form.valor.id_for_label }}" 
                               class="pl-8 w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ej: 15000" min="0" value="{{ form.valor.value|default:'' }}">
                    </div>
                    <div id="valor-preview" class="text-sm text-gray-300 mt-1"></div>
                    {% if form.valor.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.valor.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Im√°genes Actuales -->
        {% if catalitico.imagen_principal or catalitico.imagen2 or catalitico.imagen3 or catalitico.imagen4 %}
        <div class="card-glass p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4 text-white">üñºÔ∏è Im√°genes Actuales</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% if catalitico.imagen_principal %}
                    <div class="text-center">
                        <img src="{{ catalitico.imagen_principal.url }}" alt="Imagen Principal" class="w-full h-24 object-cover rounded-lg border">
                        <p class="text-xs text-gray-200 mt-1">Principal</p>
                    </div>
                {% endif %}
                {% if catalitico.imagen2 %}
                    <div class="text-center">
                        <img src="{{ catalitico.imagen2.url }}" alt="Imagen 2" class="w-full h-24 object-cover rounded-lg border">
                        <p class="text-xs text-gray-200 mt-1">Imagen 2</p>
                    </div>
                {% endif %}
                {% if catalitico.imagen3 %}
                    <div class="text-center">
                        <img src="{{ catalitico.imagen3.url }}" alt="Imagen 3" class="w-full h-24 object-cover rounded-lg border">
                        <p class="text-xs text-gray-200 mt-1">Imagen 3</p>
                    </div>
                {% endif %}
                {% if catalitico.imagen4 %}
                    <div class="text-center">
                        <img src="{{ catalitico.imagen4.url }}" alt="Imagen 4" class="w-full h-24 object-cover rounded-lg border">
                        <p class="text-xs text-gray-200 mt-1">Imagen 4</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <!-- Actualizar Im√°genes -->
        <div class="card-glass p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4 text-white">üîÑ Actualizar Im√°genes</h2>
            <p class="text-sm text-gray-200 mb-4">Selecciona nuevas im√°genes solo si deseas cambiar las actuales</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.imagen_principal.id_for_label }}">{{ form.imagen_principal.label }}</label>
                    {{ form.imagen_principal }}
                    {% if form.imagen_principal.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.imagen_principal.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.imagen2.id_for_label }}">{{ form.imagen2.label }}</label>
                    {{ form.imagen2 }}
                    {% if form.imagen2.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.imagen2.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.imagen3.id_for_label }}">{{ form.imagen3.label }}</label>
                    {{ form.imagen3 }}
                    {% if form.imagen3.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.imagen3.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.imagen4.id_for_label }}">{{ form.imagen4.label }}</label>
                    {{ form.imagen4 }}
                    {% if form.imagen4.errors %}
                        <div class="mensaje-validacion mensaje-error">
                            {% for error in form.imagen4.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Informaci√≥n de Uso -->
        <div id="info-uso" class="card-glass p-4 mb-4">
            <h3 class="font-semibold mb-2">üìä Informaci√≥n de Uso</h3>
            <div id="contenido-uso">
                <p class="text-sm text-yellow-200">Cargando informaci√≥n...</p>
            </div>
        </div>
        <!-- Botones de Acci√≥n -->
        <div class="flex flex-col md:flex-row gap-3 pt-4">
            <button type="submit" class="btn-primary flex-1">
                ‚úÖ Guardar Cambios
            </button>
            <a href="{% url 'cataliticos:listado' %}" class="btn-secondary flex-1 text-center">
                ‚ùå Cancelar
            </a>
            <button type="button" onclick="confirmarEliminar()" class="btn-danger">
                üóëÔ∏è Eliminar
            </button>
        </div>
    </form>
    <!-- Informaci√≥n adicional -->
    <div class="mt-6 p-4 card-glass">
        <h3 class="font-semibold mb-2">‚ÑπÔ∏è Instrucciones:</h3>
        <ul class="text-sm text-white space-y-1">
            <li>‚Ä¢ Los campos marcados con <span class="campo-requerido">*</span> son obligatorios</li>
            <li>‚Ä¢ El c√≥digo debe ser √∫nico en todo el sistema</li>
            <li>‚Ä¢ Solo selecciona nuevas im√°genes si deseas cambiar las actuales</li>
            <li>‚Ä¢ Si este catal√≠tico est√° en uso, no podr√° ser eliminado</li>
        </ul>
    </div>
</div>
<script>
let codigoTimeout;
const cataliticoId = {{ catalitico.id }};

// Validaci√≥n en tiempo real del c√≥digo
document.addEventListener('DOMContentLoaded', function() {
    const codigoInput = document.getElementById('id_codigo');
    const valorInput = document.getElementById('id_valor');
    
    // Cargar informaci√≥n de uso
    cargarInformacionUso();
    
    if (codigoInput) {
        // Convertir a may√∫sculas autom√°ticamente
        codigoInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            
            // Limpiar timeout anterior
            clearTimeout(codigoTimeout);
            
            // Limpiar estilos previos
            this.classList.remove('codigo-disponible', 'codigo-duplicado');
            const validacionDiv = document.getElementById('codigo-validacion');
            validacionDiv.style.display = 'none';
            
            // Verificar despu√©s de 500ms de inactividad
            if (this.value.trim()) {
                codigoTimeout = setTimeout(() => {
                    verificarCodigoUnico(this.value.trim());
                }, 500);
            }
        });
    }
    
    if (valorInput) {
        valorInput.addEventListener('input', function() {
            actualizarPreviewValor(this.value);
        });
        
        // Actualizar preview inicial
        if (valorInput.value) {
            actualizarPreviewValor(valorInput.value);
        }
    }
});

async function verificarCodigoUnico(codigo) {
    if (!codigo) return;
    
    try {
        const response = await fetch(`/api/verificar-codigo/?codigo=${encodeURIComponent(codigo)}&id=${cataliticoId}`);
        const data = await response.json();
        
        const codigoInput = document.getElementById('id_codigo');
        const validacionDiv = document.getElementById('codigo-validacion');
        
        if (data.existe) {
            codigoInput.classList.add('codigo-duplicado');
            codigoInput.classList.remove('codigo-disponible');
            validacionDiv.className = 'mensaje-validacion mensaje-error';
            validacionDiv.textContent = `‚ùå ${data.mensaje}`;
        } else {
            codigoInput.classList.add('codigo-disponible');
            codigoInput.classList.remove('codigo-duplicado');
            validacionDiv.className = 'mensaje-validacion mensaje-exito';
            validacionDiv.textContent = `‚úÖ ${data.mensaje}`;
        }
        
        validacionDiv.style.display = 'block';
    } catch (error) {
        console.error('Error al verificar c√≥digo:', error);
    }
}

async function cargarInformacionUso() {
    try {
        const response = await fetch(`/api/verificar-eliminacion/${cataliticoId}/`);
        const data = await response.json();
        
        const contenidoDiv = document.getElementById('contenido-uso');
        
        if (data.puede_eliminar) {
            contenidoDiv.innerHTML = `
                <p class="text-sm text-green-200">‚úÖ Este catal√≠tico no est√° siendo usado en ninguna compra y puede ser eliminado.</p>
            `;
            document.getElementById('info-uso').className = 'bg-green-500 bg-opacity-30 rounded-lg p-4 border border-green-400 border-opacity-50 backdrop-filter backdrop-blur-sm';
        } else {
            contenidoDiv.innerHTML = `
                <p class="text-sm text-yellow-200">‚ö†Ô∏è Este catal√≠tico est√° siendo usado en <strong>${data.total_compras}</strong> compra(s).</p>
                <p class="text-xs text-yellow-200 mt-1">No puede ser eliminado mientras est√© en uso.</p>
            `;
        }
    } catch (error) {
        console.error('Error al cargar informaci√≥n de uso:', error);
        document.getElementById('contenido-uso').innerHTML = `
            <p class="text-sm text-red-700">‚ùå Error al cargar informaci√≥n de uso</p>
        `;
    }
}

function actualizarPreviewValor(valor) {
    const previewDiv = document.getElementById('valor-preview');
    if (valor && !isNaN(valor)) {
        const valorFormateado = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0
        }).format(valor);
        previewDiv.textContent = `Vista previa: ${valorFormateado}`;
    } else {
        previewDiv.textContent = '';
    }
}

function validarFormulario() {
    const codigoInput = document.getElementById('id_codigo');
    const descripcionInput = document.getElementById('id_descripcion');
    const valorInput = document.getElementById('id_valor');
    
    // Verificar campos requeridos
    if (!codigoInput.value.trim()) {
        alert('‚ö†Ô∏è El c√≥digo es obligatorio');
        codigoInput.focus();
        return false;
    }
    
    if (!descripcionInput.value.trim()) {
        alert('‚ö†Ô∏è La descripci√≥n es obligatoria');
        descripcionInput.focus();
        return false;
    }
    
    if (!valorInput.value || valorInput.value <= 0) {
        alert('‚ö†Ô∏è El valor debe ser mayor a 0');
        valorInput.focus();
        return false;
    }
    
    // Verificar si el c√≥digo est√° marcado como duplicado
    if (codigoInput.classList.contains('codigo-duplicado')) {
        alert('‚ùå No se puede guardar un catal√≠tico con un c√≥digo duplicado');
        codigoInput.focus();
        return false;
    }
    
    return true;
}

async function confirmarEliminar() {
    try {
        const response = await fetch(`/api/verificar-eliminacion/${cataliticoId}/`);
        const data = await response.json();
        
        if (!data.puede_eliminar) {
            alert(`‚ùå No se puede eliminar este catal√≠tico porque est√° siendo usado en ${data.total_compras} compra(s).`);
            return;
        }
        
        if (confirm('¬øEst√°s seguro de que deseas eliminar este catal√≠tico? Esta acci√≥n no se puede deshacer.')) {
            window.location.href = '{% url "cataliticos:eliminar" catalitico.id %}';
        }
    } catch (error) {
        console.error('Error al verificar eliminaci√≥n:', error);
        alert('‚ùå Error al verificar si el catal√≠tico puede ser eliminado');
    }
}
</script>

{% endblock content %}
