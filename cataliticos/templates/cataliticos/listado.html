{% extends 'base.html' %}
{% load humanize %}
{% block title %}Listado de Catal칤ticos{% endblock %}
{% block content %}

<style>
body {
    background: linear-gradient(120deg, #0f2027, #2c5364 60%, #232526 100%);
    min-height: 100vh;
    overflow-x: hidden;
}
.dashboard-container, .form-card, .glass-card, .main-card, .max-w-xl, .max-w-4xl {
    background: rgba(30, 30, 60, 0.55) !important;
    backdrop-filter: blur(18px) saturate(180%) !important;
    border-radius: 22px !important;
    border: 1.5px solid rgba(0,255,255,0.18) !important;
    box-shadow: 0 8px 40px 0 rgba(0,255,255,0.12), 0 1.5px 8px 0 rgba(255,0,255,0.10) !important;
    color: #e0eaff !important;
}
input, select, textarea {
    color: #fff !important;
    background-color: rgba(255, 255, 255, 0.10) !important;
    border: 1px solid rgba(0,255,255,0.18) !important;
    border-radius: 0.7rem !important;
    padding: 0.75rem !important;
    font-size: 0.95rem !important;
    transition: all 0.2s cubic-bezier(.4,2,.6,1);
    backdrop-filter: blur(8px);
}
input::placeholder, select::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.7) !important;
}
input:focus, select:focus, textarea:focus {
    outline: none !important;
    border-color: #00fff7 !important;
    box-shadow: 0 0 0 3px rgba(0,255,255,0.18) !important;
    background-color: rgba(255, 255, 255, 0.18) !important;
}
label {
    color: #b388ff !important;
    font-weight: 700 !important;
    margin-bottom: 0.5rem !important;
    display: block !important;
    letter-spacing: 1px;
}
</style>

<div class="max-w-xl mx-auto p-6 main-card">

    <h1 class="text-2xl font-bold mb-6 text-center">Listado de Catal칤ticos</h1>

    <!-- Buscador -->
    <form method="GET" action="{% url 'cataliticos:listado' %}" class="mb-4">
        <input type="text" id="busqueda-codigo" name="q" placeholder="Buscar c칩digo..." value="{{ codigo }}"
            class="w-full p-3 rounded-xl bg-white/10 backdrop-blur-sm border border-white/30 placeholder-black/70 text-black focus:outline-none focus:ring-2 focus:ring-cyan-300 focus:bg-white/15" autocomplete="off">
    </form>
    <div id="resultados-busqueda"></div>

    {% if codigo and resultado %}
        <!-- Ficha del catal칤tico -->
        <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-4 shadow-md space-y-2">
            <h2 class="text-xl font-bold">游댢 {{ resultado.codigo }}</h2>
            <p class="text-white/80 text-sm">Marca/Descripci칩n: {{ resultado.descripcion|default:"Sin descripci칩n" }}</p>
            <p class="text-white/90 text-sm">Valor: ${{ resultado.valor|floatformat:0|intcomma }}</p>
            {% if resultado.imagen_principal %}
                <img src="{{ resultado.imagen_principal.url }}" alt="Foto 1"
                     class="rounded-xl mt-3 max-w-[200px] max-h-[200px] object-cover border-0 mx-auto">
            {% endif %}

            {% if resultado.galeria %}
                <img src="{{ resultado.galeria.url }}" alt="Foto 2"
                     class="rounded-xl mt-3 max-w-[200px] max-h-[200px] object-cover border-0 mt-2 mx-auto">
                <img src="" alt="Foto 3"
                     class="rounded-xl mt-3 max-w-[200px] max-h-[200px] object-cover border-0 mt-2 mx-auto">
                <img src="" alt="Foto 4"
                     class="rounded-xl mt-3 max-w-[200px] max-h-[200px] object-cover border-0 mt-2 mx-auto">
            {% endif %}

            <a href="{% url 'cataliticos:editar' resultado.id %}" 
               class="inline-block mt-4 bg-white/20 backdrop-blur-sm border border-white/30 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition">
               Editar Catal칤tico
            </a>
        </div>

    {% elif codigo and not resultado %}
        <!-- No se encontr칩 -->
        <div class="bg-yellow-500/20 backdrop-blur-sm border border-yellow-400/40 text-white p-4 rounded-xl text-center">
            <p class="mb-2">El c칩digo <strong>{{ codigo }}</strong> no est치 registrado.</p>
            <a href="{% url 'cataliticos:crear' %}?codigo={{ codigo }}" 
               class="inline-block bg-blue-500/30 backdrop-blur-sm border border-blue-400/50 text-white px-4 py-2 rounded-lg hover:bg-blue-500/40 transition">
               Crear este catal칤tico
            </a>
        </div>

    {% else %}
        <!-- Listado completo -->
        <div class="space-y-3">
            {% for catalitico in cataliticos %}
                <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-3 flex items-center justify-between hover:bg-white/15 transition">
                    <div>
                        <p class="font-bold text-lg">游댢 {{ catalitico.codigo }}</p>
                        <p class="text-sm uppercase text-white/70">{{ catalitico.descripcion|default:"Sin marca" }}</p>
                    </div>
                    <a href="{% url 'cataliticos:editar' catalitico.id %}" class="text-sm text-white hover:text-cyan-300 bg-white/20 px-3 py-1 rounded-lg border border-white/30 hover:bg-white/30 transition">Editar</a>
                </div>
            {% empty %}
                <p class="text-white text-center mt-4">No hay catal칤ticos registrados a칰n.</p>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Bot칩n flotante -->
    <a href="{% url 'cataliticos:crear' %}" 
       class="fixed bottom-6 right-6 bg-blue-500/30 backdrop-blur-sm border border-blue-400/50 hover:bg-blue-500/40 text-white p-4 rounded-full shadow-lg transition text-xl">+</a>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('busqueda-codigo');
    const resultadosDiv = document.getElementById('resultados-busqueda');
    let timeout = null;
    input.addEventListener('input', function() {
        clearTimeout(timeout);
        const valor = this.value.trim();
        if (valor.length === 0) {
            resultadosDiv.innerHTML = '';
            return;
        }
        resultadosDiv.innerHTML = '<div class="text-center text-black/70 py-4">Buscando...</div>';
        timeout = setTimeout(() => {
            fetch(`{% url 'cataliticos:api_buscar_catalitico' %}?term=${encodeURIComponent(valor)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.results.length === 0) {
                        resultadosDiv.innerHTML = '<div class="text-center text-black/70 py-4">No se encontraron resultados.</div>';
                        return;
                    }
                    resultadosDiv.innerHTML = data.results.map(c => `
                        <div class='bg-white/80 backdrop-blur-sm border border-white/20 rounded-xl p-3 flex items-center justify-between hover:bg-white/90 transition mb-2'>
                            <div>
                                <p class='font-bold text-lg text-black'>游댢 ${c.text}</p>
                                <p class='text-sm uppercase text-black/70'>${c.descripcion || 'Sin marca'}</p>
                                <p class='text-sm text-black/80'>Valor: $${c.valor.toLocaleString('es-CL')}</p>
                            </div>
                            <a href='{% url 'cataliticos:editar' 0 %}'.replace('0', c.id) class='text-sm text-black hover:text-cyan-700 bg-white/40 px-3 py-1 rounded-lg border border-white/30 hover:bg-white/60 transition'>Editar</a>
                        </div>
                    `).join('');
                });
        }, 350);
    });
});
</script>

{% endblock %}
